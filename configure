#!/bin/bash

CONFIG=config
CONFIGURE_STATUS=configure.status
out=$CONFIGURE_STATUS

prefix=/usr/local
function argument {
	echo ${1} | awk 'BEGIN { FS = "="} {print $2}'
}

function help {
	echo "${0} [options]"
	printf "Configuration:\n"
	printf "\t--help\t\t\tdisplay this help and exit\n"
	printf "Installation directories:\n"
	printf "\t--prefix=PREFIX\t\tinstall architecture-independent files in PREFIX [/usr/local]\n"
	printf "\t--bindir=DIR\t\tuser executables [PREFIX/bin]\n"
	printf "\t--sbindir=DIR\t\tsystem admin executables [PREFIX/sbin]\n"
	printf "\t--sysconfdir=DIR\tread-only single-machine data [PREFIX/etc]\n"
	printf "\t--libdir=DIR\t\tobject code libraries [PREFIX/lib]\n"
	printf "\t--includedir=DIR\tC header files [PREFIX/include]\n"
	printf "\t--datadir=DIR\t\tread-only architecture-independent data [PREFIX/share]\n"
	printf "System types:\n"
	printf "\t--build=BUILD\t\tconfigure for building on BUILD [guessed]\n"
	printf "\t--host=HOST\t\tcross-compile to build programs to run on HOST [BUILD]\n"
	printf "\t--sysroot=DIR\t\tcross-compiler root directory [none]\n"
	exit
}

while [ "${1}" != "" ]; do
	case ${1} in
		--prefix*)
			prefix=$(argument ${1})
			;;
		--bindir*)
			bindir=$(argument ${1})
			;;
		--sbindir*)
			sbindir=$(argument ${1})
			;;
		--includedir*)
			includedir=$(argument ${1})
			;;
		--libdir*)
			libdir=$(argument ${1})
			;;
		--datadir*)
			datadir=$(argument ${1})
			;;
		--sysconfdir*)
			sysconfdir=$(argument ${1})
			;;
		--host*)
			CROSS_COMPILER=$(argument ${1})
			;;
		--sysroot*)
			sysroot=$(argument ${1})
			;;
		--help*)
			help
			;;
		*)
			printf "\x1B[31m\n\tbad argument: ${1}\n\n\x1B[0m"
			help
	esac
	shift
done

if [ -z ${bindir} ]; then
	bindir=${prefix}/bin
fi
if [ -z ${sbindir} ]; then
	sbindir=${prefix}/sbin
fi
if [ -z ${includedir} ]; then
	includedir=${prefix}/include
fi
if [ -z ${libdir} ]; then
	libdir=${prefix}/lib
fi
if [ -z ${sysconfdir} ]; then
	sysconfdir=${prefix}/etc
fi

echo "#Makemore 1.0" > $out
echo "prefix=\""$prefix"\"" >> $out
echo "bindir=\""$bindir"\"" >> $out
echo "sbindir=\""$sbindir"\"" >> $out
echo "includedir=\""$includedir"\"" >> $out
echo "libdir=\""$libdir"\"" >> $out
echo "sysconfdir=\""$sysconfdir"\"" >> $out
if [ $sysroot ]; then
	echo "sysroot=\""$sysroot"\"" >> $out
fi
if [ $CROSS_COMPILER ]; then
	echo "CROSS_COMPILER="$CROSS_COMPILER >> $out
fi

if [ ! -e config -a -e default.config ]; then
	cp default.config config
fi
make check
if [ $? != 0 ]; then
	echo "binary dependences failed"
	exit -1
fi
